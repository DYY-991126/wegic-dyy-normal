<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速 Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            display: flex;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            overflow: hidden; /* 防止整体滚动 */
        }

        .container {
            display: flex;
            width: calc(100% - 32px);
            height: calc(100vh - 32px);
            margin: 16px;
            gap: 10px;
        }

        .left-panel {
            flex: 75%;
            padding: 0;
            background-color: #ffffff;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            margin: 16px;
        }

        .right-panel {
            flex: 25%;
            background-color: #F7F6F5;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0px 0px 2px 2px #FFF inset, 0px 0px 0px 1px rgba(0, 0, 0, 0.06), 0px 0px 10px 0px #E3E0DB;
            padding: 0;
            border-radius: 12px;
            height: 100%;
            overflow: hidden;
            z-index: 100;
        }

        .right-panel-header {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 12px 16px;
            gap: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .right-panel-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .credit-icon {
            width: 72px;
            height: 36px;
            object-fit: contain;
        }

        .upgrade-button {
            display: flex;
            height: 36px;
            padding: 0px 10px;
            justify-content: center;
            align-items: center;
            gap: 6px;
            border: none;
            border-radius: 10px;
            background: rgba(152, 117, 255, 0.10);
            color: #9875FF;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }

        .upgrade-button:hover {
            background: rgba(152, 117, 255, 0.15);
        }

        .help-icon {
            width: 36px;
            height: 36px;
            cursor: pointer;
        }

        .element {
            margin: 12px 0;
            padding: 20px;
            background-color: #ffffff;
            border: 1px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .element:hover {
            background-color: #f8f8f8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .element.selected {
            border: 3px solid #0071e3;
            background-color: rgba(0, 113, 227, 0.05);
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
        }

        /* 添加选中子元素的样式 */
        [data-selectable="true"].selected {
            outline: 3px solid #0071e3;
            background-color: rgba(0, 113, 227, 0.05);
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
        }

        /* 添加 hover 元素的框体 UI 样式 */
        [data-selectable="true"]:hover:not(.selected) {
            outline: 2px solid #0071e3;
            outline-offset: 2px;
            box-shadow: 0 0 4px rgba(0, 113, 227, 0.15);
            transition: all 0.2s ease;
        }

        /* 确保顶部栏元素不会显示hover和选中效果 */
        .top-bar [data-selectable="true"]:hover:not(.selected),
        .top-bar [data-selectable="true"].selected,
        .top-bar .element:hover,
        .top-bar .element.selected {
            outline: none !important;
            box-shadow: none !important;
            background-color: transparent !important;
            border-color: transparent !important;
        }

        /* 子元素被选中时父元素的样式 */
        .element.parent-of-selected {
            border: 2px dashed #0071e3;
            background-color: rgba(0, 113, 227, 0.02);
        }

        .toolbar {
            position: fixed; /* 改为固定定位 */
            width: 220px;
            background-color: #ffffff;
            border-radius: 12px;
            padding: 12px 0;
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.32), 0px 0px 8px 0px rgba(0, 0, 0, 0.08);
            display: none;
            z-index: 1000; /* 提高层级 */
            animation: fadeIn 0.2s ease;
            overflow: visible;
            /* 添加用于拖动的属性 */
            user-select: none;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        /* 箭头SVG样式 */
        .toolbar-arrow {
            position: absolute;
            right: -13px; /* 箭头宽度 */
            bottom: 50px; /* 调整箭头的垂直位置，与图片对应 */
            filter: drop-shadow(1px 0px 2px rgba(49, 49, 49, 0.15));
            z-index: -1;
            pointer-events: none;
            width: 13px;
            height: 32px;
            transform: rotate(0deg); /* 将箭头旋转,使其水平指向 */
        }
        
        /* 拖动时箭头的样式 */
        .toolbar.dragging .toolbar-arrow {
            filter: drop-shadow(2px 1px 3px rgba(0, 0, 0, 0.25));
        }

        .toolbar.dragging {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            transform: scale(1.02);
        }

        .toolbar.dragging::after {
            box-shadow: 3px 3px 5px 0 rgba(0, 0, 0, 0.12);
        }

        .toolbar-title {
            color: #333333;
            font-size: 15px;
            padding: 10px 10px 0px 16px;
            margin-bottom: 10px;
            cursor: move; /* 显示拖动光标 */
            position: relative; /* 为定位拖动手柄 */
            font-weight: 500;
            opacity: 0.35; /* 添加35%不透明度 */
        }

        .toolbar-title::before {
            content: ""; /* 移除拖动图标 */
            position: absolute;
            left: 8px;
            color: #666;
        }
        
        .toolbar-divider {
            padding: 4px 20px;
            margin: 0px 0;
        }
        
        .delete-button {
            margin-top: 5px !important;
        }
        
        /* IP人物容器样式 */
        .ip-character-container {
            position: fixed; /* 改为固定定位 */
            width: 60px;
            height: 60px;
            z-index: 999; /* 确保在工具栏下方 */
            pointer-events: none;
            display: none;
            filter: drop-shadow(0px 0px 5px rgba(0, 0, 0, 0.15));
            transform-origin: center center;
            animation: appearAnimation 0.3s ease-out;
        }
        
        .ip-character-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            animation: floatAnimation 3s ease-in-out infinite;
        }
        
        @keyframes appearAnimation {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes floatAnimation {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toolbar button {
            display: flex;
            align-items: center;
            width: 100%;
            margin: 2px 0;
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 16px;
            text-align: left;
            color: #333333;
            transition: all 0.1s ease;
            border-radius: 0;
        }

        .toolbar button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .toolbar button .icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .input-container {
            margin-top: auto;
            position: relative;
            width: calc(100% - 32px);
            margin-left: 16px;
            margin-right: 16px;
            margin-bottom: 16px;
        }
        
        /* 对话记录区域样式 */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px; /* 调整内边距 */
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            animation: messageAppear 0.3s ease;
        }
        
        .message.user {
            align-self: flex-end;
            background-color: #0071e3;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.ai {
            align-self: flex-start;
            background-color: #f2f2f7;
            color: #1d1d1f;
            border-bottom-left-radius: 4px;
        }
        
        @keyframes messageAppear {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .input-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 67px; /* 保持默认最小高度 */
            max-height: none; /* 移除最大高度限制，允许随内容自动扩展 */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background-color: #FFF;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }
        
        .input-wrapper.with-tag {
            height: auto; /* 改为auto，随内容自动调整高度 */
            min-height: 104px; /* 保持最小高度 */
        }
        
        .input-wrapper.focused {
            border-color: #0071e3;
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
        }
        
        /* 输入框焦点动画 */
        @keyframes focusAttention {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        
        .input-focus-animation {
            animation: focusAttention 0.6s ease;
        }
        
        @keyframes tagAppear {
            0% { transform: translateY(-10px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes tagDisappear {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-10px); opacity: 0; }
        }
        
        @keyframes pulseEffect {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .input-tag-container {
            display: flex; 
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            min-height: 0; /* 修改为0确保不占空间 */
            background-color: #000;
            border-radius: 12px 12px 0 0;
            padding: 0; /* 默认无内边距 */
            position: relative;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            opacity: 0;
            height: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, height 0.3s ease, max-height 0.3s ease, padding 0.3s ease;
        }
        
        .input-tag-container.visible {
            opacity: 1;
            height: auto; /* 确保高度随内容变化 */
            max-height: none; /* 取消最大高度限制，确保内容完全显示 */
            min-height: 40px; /* 仅在可见时设置最小高度 */
            padding: 0 12px; /* 仅在可见时添加内边距 */
            animation: tagAppear 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .tag-top-container {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            width: 100%;
        }
        
        .input-tag-container.hiding {
            opacity: 0;
            height: 0;
            animation: tagDisappear 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .input-tag {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #fff;
            font-weight: 500;
            animation: pulseEffect 0.5s ease;
        }
        
        .input-tag .icon {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .input-tag-close {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: #fff;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .input-tag-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        /* 为标签容器内的建议增加样式 */
        .suggestion-container {
            display: none; /* 默认隐藏，只在输入框聚焦时显示 */
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            padding: 12px;
            gap: 4px;
            overflow: visible; /* 修改为visible，确保不会隐藏内容 */
            max-height: none; /* 移除高度限制 */
            margin-top: 6px; /* 与顶部内容保持间距 */
        }
        
        /* 输入框聚焦时显示建议容器 */
        .input-wrapper.focused .suggestion-container {
            display: flex;
            gap: 8px;
        }

        .suggestion-slider {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            overflow: visible; /* 修改为visible，确保不会隐藏内容 */
            width: 100%;
            max-height: none; /* 移除高度限制 */
        }

        .suggestion-arrow {
            color: #fff;
            margin-right: 8px;
            font-size: 16px;
        }

        .suggestion-option {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        
        .suggestion-option:last-child {
            margin-bottom: 0;
        }

        .suggestion-option:hover,
        .suggestion-option.active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .suggestion-option.active {
            border-left: 3px solid #fff;
        }
        
        .suggestion-option::after {
            content: '→';
            position: absolute;
            right: 12px;
            color: #ffffff;
            font-size: 16px;
        }
        
        .input-content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            min-height: 67px; /* 设置最小高度，确保不会被压缩 */
            max-height: 120px; /* 保持最大高度限制 */
            border-radius: 0 0 12px 12px;
        }
        
        .input-text-area {
            flex: 1;
            padding: 12px 16px;
            min-height: 40px;
            border: none;
            font-size: 14px;
            background-color: transparent;
            outline: none;
            resize: none;
            overflow-y: auto;
        }
        
        .input-actions {
            display: flex;
            justify-content: space-between;
            padding: 8px 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.04);
        }
        
        .input-left-actions {
            display: flex;
            gap: 12px;
        }
        
        .input-right-actions {
            display: flex;
        }
        
        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .action-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: #333;
        }
        
        .send-button {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 4px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .send-button:hover {
            background-color: #0077ed;
        }
        
        .suggestion-panel {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .suggestion-panel.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .suggestion-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: #86868b;
            font-size: 14px;
        }

        .suggestion-header .icon {
            margin-right: 8px;
            color: #86868b;
        }

        .suggestion-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 14px;
            color: #1d1d1f;
            transition: color 0.2s ease;
        }

        .suggestion-item:hover {
            color: #0071e3;
            cursor: pointer;
        }
        
        /* 添加选中/悬停时的背景样式 */
        .suggestion-item:hover, .suggestion-item.active {
            background-color: rgba(0, 113, 227, 0.08);
            border-radius: 6px;
            padding: 10px 8px;
            margin: 0 -8px;
        }
        
        /* 选中状态的样式 */
        .suggestion-item.active {
            color: #0071e3;
            font-weight: 500;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .thumbnail {
            display: inline-block;
            width: 40px;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 6px;
            margin-left: 8px;
            vertical-align: middle;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1d1d1f;
            padding: 0 24px; /* 添加左右内边距 */
        }

        /* 新增网页元素样式 */
        .hero-section {
            margin: -24px -24px 24px -24px;
            padding: 48px 24px;
            background: linear-gradient(135deg, #0071e3, #00a0ff);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .hero-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .hero-description {
            font-size: 16px;
            line-height: 1.6;
            opacity: 0.9;
            max-width: 600px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .feature-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            font-size: 24px;
            margin-bottom: 16px;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1d1d1f;
        }

        .feature-description {
            font-size: 14px;
            line-height: 1.5;
            color: #86868b;
        }

        .content-section {
            margin: 32px 0;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .article {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .article-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1d1d1f;
        }

        .article-meta {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }

        .article-meta span {
            margin-right: 16px;
        }

        .article-content {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 16px;
        }

        .article-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin: 16px 0;
        }

        .tag {
            display: inline-block;
            padding: 4px 12px;
            background-color: #f5f5f7;
            border-radius: 100px;
            font-size: 13px;
            color: #1d1d1f;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .cta-button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #0071e3;
            color: white;
            border-radius: 100px;
            font-size: 15px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .cta-button:hover {
            background-color: #0077ed;
            transform: translateY(-1px);
        }

        .newsletter-section {
            background: linear-gradient(135deg, #f5f5f7, #e5e5e7);
            border-radius: 12px;
            padding: 32px;
            margin: 32px 0;
        }

        .newsletter-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .newsletter-description {
            font-size: 15px;
            line-height: 1.5;
            color: #666;
            margin-bottom: 24px;
        }

        /* 顶部栏样式 */
        .top-bar {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #ffffff;
            box-shadow: 0px 1px 0px 0px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 999999;
            flex-shrink: 0;
        }

        /* 中间区域样式 */
        .center-section {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .center-section img {
            width: 195px;
            height: 24px;
            object-fit: contain;
        }

        /* 左侧区域样式 */
        .left-section {
            display: flex;
            align-items: center;
            gap: 12px; /* 设置间距为 12px */
        }

        /* 工作区图标样式 */
        .workspace-icon {
            width: 32px;
            height: 32px;
        }

        /* 下拉菜单按钮样式 */
        .dropdown-menu-btn {
            display: flex;
            height: 36px;
            padding: 0px 10px 0px 12px;
            align-items: center;
            gap: 8px;
            border: none;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.04);
            cursor: pointer;
        }

        .dropdown-menu-btn span {
            font-size: 14px;
            color: #000;
        }

        .dropdown-menu-btn img {
            width: 16px;
            height: 16px;
        }

        .dropdown-menu-btn:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        /* 右侧区域样式 */
        .right-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-button {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .tool-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* 修改 preview-btn 样式 */
        .preview-btn {
            display: flex;
            width: 88px;
            height: 36px;
            padding: 6px 16px;
            justify-content: center;
            align-items: center;
            border: none;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.04);
            font-size: 14px;
            color: #000;
            cursor: pointer;
        }

        .preview-btn:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        /* 修改 publish-btn 样式 */
        .publish-btn {
            display: flex;
            width: 88px;
            height: 36px;
            padding: 0px 10px 2px 10px;
            justify-content: center;
            align-items: center;
            border: none;
            border-radius: 10px;
            background: #000;
            box-shadow: 0px 1px 1px 0px rgba(0, 0, 0, 0.20),
                        0px 0px 0px 1px #000,
                        0px 20px 20px 0px rgba(0, 0, 0, 0.04) inset,
                        0px -2px 1px 1px rgba(255, 255, 255, 0.20) inset,
                        0px 1px 4px 1px rgba(255, 255, 255, 0.20) inset,
                        0px -1px 1px 0px rgba(255, 255, 255, 0.20) inset,
                        0px 1px 0px 0px rgba(255, 255, 255, 0.20) inset;
            font-size: 14px;
            color: #FFF;
            cursor: pointer;
        }

        .publish-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        /* 工具按钮组样式 */
        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 16px;
        }

        .tool-button img {
            width: 32px;
            height: 32px;
        }

        .credit-icon {
            width: 32px;
            height: 32px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel" id="leftPanel">
            <!-- 顶部栏 -->
            <div class="top-bar">
                <!-- 左侧区域 -->
                <div class="left-section">
                    <svg class="workspace-icon" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M25 18.9999C25 17.7112 23.9553 16.6665 22.6667 16.6665H13.3333C12.0447 16.6665 11 17.7112 11 18.9999M13.3333 11.9999H15.4779C16.0968 11.9999 16.6903 12.2457 17.1279 12.6833L17.3166 12.872C17.7542 13.3096 18.3477 13.5554 18.9665 13.5554H22.6667C23.9553 13.5554 25 14.6001 25 15.8888V21.3332C25 22.6219 23.9553 23.6665 22.6667 23.6665H13.3333C12.0447 23.6665 11 22.6219 11 21.3332V14.3332C11 13.0445 12.0447 11.9999 13.3333 11.9999Z" stroke="black" stroke-width="1.85" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <button class="dropdown-menu-btn">
                        <span>Home</span>
                        <img src="resource/dropdown.svg" alt="dropdown">
                    </button>
                </div>

                <!-- 中间区域 - URL Status -->
                <div class="center-section">
                    <img src="resource/urlStatue.png" alt="URL Status" style="width: 211px; height: 36px;">
                </div>

                <!-- 右侧区域 -->
                <div class="right-section">
                    <!-- 工具按钮组 -->
                    <div class="tool-group">
                        <svg class="tool-button" title="Style" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M22.2314 17.3566L20.5707 20.4654C20.2181 21.1254 20.1458 21.8994 20.3699 22.6133L20.4252 22.7892C20.757 23.8461 21.7365 24.5652 22.8443 24.5652C23.9521 24.5652 24.9317 23.8461 25.2635 22.7892L25.3187 22.6133C25.5429 21.8994 25.4706 21.1254 25.118 20.4654L23.4572 17.3566C23.3364 17.1304 23.1008 16.9892 22.8443 16.9892C22.5878 16.9892 22.3523 17.1304 22.2314 17.3566Z" fill="black"/>
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M12.458 23.835C12.3301 24.1764 12.0009 24.4194 11.6148 24.4194C11.1178 24.4194 10.7148 24.0165 10.7148 23.5194C10.7148 23.3937 10.7406 23.2741 10.7871 23.1655L15.5894 11.1846C15.8869 10.4422 16.9327 10.4277 17.2507 11.1616L20.0493 17.6212L18.788 20.0305H13.9838L12.458 23.835ZM18.3516 18.2305H14.7051L16.4572 13.8581L18.3516 18.2305Z" fill="black"/>
                        </svg>
                        <svg class="tool-button" title="Setting" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M17.1721 10.57C17.6862 10.2809 18.3138 10.2809 18.8279 10.57L24.1391 13.5576C24.6709 13.8567 25 14.4194 25 15.0295V20.9707C25 21.5808 24.6709 22.1434 24.1391 22.4426L18.8279 25.43C18.3138 25.7192 17.6862 25.7193 17.1721 25.4301L11.8609 22.4428C11.3291 22.1437 11 21.581 11 20.9709V15.0294C11 14.4193 11.3291 13.8567 11.8608 13.5575L17.1721 10.57ZM12.8601 15.1296L18 12.2384L23.1399 15.1296V20.8705L18 23.7617L12.8601 20.8707V15.1296ZM20.9968 18.0001C20.9968 19.6551 19.6552 20.9968 18.0001 20.9968C16.345 20.9968 15.0033 19.6551 15.0033 18.0001C15.0033 16.345 16.345 15.0033 18.0001 15.0033C19.6551 15.0033 20.9968 16.345 20.9968 18.0001ZM19.1368 18.0001C19.1368 17.3723 18.6278 16.8634 18.0001 16.8634C17.3723 16.8634 16.8633 17.3722 16.8633 18.0001C16.8633 18.6278 17.3723 19.1368 18.0001 19.1368C18.6279 19.1368 19.1368 18.6279 19.1368 18.0001Z" fill="black"/>
                        </svg>
                        <svg class="tool-button" title="Device" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M13.1458 11.1302C12.6942 11.1671 12.3177 11.2624 12.0161 11.4161C11.4704 11.6941 11.0268 12.1378 10.7487 12.6834C10.5951 12.985 10.4998 13.3616 10.4629 13.8131V19.5202C10.4998 19.9718 10.5951 20.3483 10.7487 20.6499C11.0268 21.1956 11.4704 21.6392 12.0161 21.9173C12.3177 22.071 12.6942 22.1662 13.1458 22.2031H22.8528C23.3044 22.1662 23.6809 22.071 23.9825 21.9173C24.5282 21.6392 24.9718 21.1956 25.2499 20.6499C25.4036 20.3483 25.4989 19.9718 25.5357 19.5202V13.8131C25.4989 13.3616 25.4036 12.985 25.2499 12.6834C24.9718 12.1378 24.5282 11.6941 23.9825 11.4161C23.6809 11.2624 23.3044 11.1671 22.8528 11.1302H13.1458ZM12.8333 13.0199C12.6263 13.1254 12.458 13.2936 12.3525 13.5006C12.3064 13.5912 12.2745 13.7442 12.2569 13.9597V19.3737C12.2745 19.5891 12.3064 19.7422 12.3525 19.8327C12.458 20.0397 12.6263 20.208 12.8333 20.3134C12.9238 20.3596 13.0769 20.3915 13.2923 20.4091H22.7062C22.9218 20.3915 23.0748 20.3596 23.1653 20.3134C23.3723 20.208 23.5406 20.0397 23.646 19.8327C23.6922 19.7422 23.7241 19.5891 23.7417 19.3737V13.9597C23.7241 13.7442 23.6922 13.5912 23.646 13.5006C23.5406 13.2936 23.3723 13.1254 23.1653 13.0199C23.0748 12.9738 22.9218 12.9419 22.7062 12.9243H13.2923C13.0769 12.9419 12.9238 12.9738 12.8333 13.0199Z" fill="black"/>
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M15.0472 24.9C15.1929 24.9 15.3305 24.8654 15.4522 24.804C16.2512 24.4235 17.1003 24.2333 17.9993 24.2333C18.8984 24.2333 19.7474 24.4235 20.5465 24.804C20.6682 24.8654 20.8058 24.9 20.9514 24.9C21.4485 24.9 21.8514 24.4971 21.8514 24C21.8514 23.6349 21.6339 23.3205 21.3215 23.1794C20.2774 22.682 19.1701 22.4333 17.9993 22.4333C16.8286 22.4333 15.7212 22.682 14.6771 23.1794C14.3646 23.3205 14.1472 23.6349 14.1472 24C14.1472 24.4971 14.5501 24.9 15.0472 24.9Z" fill="black"/>
                        </svg>
                    </div>
                    <button class="preview-btn">Preview</button>
                    <button class="publish-btn">Publish</button>
                </div>
            </div>

            <!-- 内容区域容器 -->
            <div class="panel-content">
                <div class="hero-section">
                    <h1 class="hero-title">探索无限可能</h1>
                    <p class="hero-description">发现创新科技，连接智慧未来。我们致力于为您提供最前沿的技术资讯和解决方案。</p>
                </div>

                <div class="card-grid">
                    <div class="feature-card element" data-element="1">
                        <div class="feature-icon">🚀</div>
                        <h3 class="feature-title">快速部署</h3>
                        <p class="feature-description">只需几分钟即可完成应用部署，让您的想法立即变为现实。</p>
                    </div>
                    <div class="feature-card element" data-element="2">
                        <div class="feature-icon">🛡️</div>
                        <h3 class="feature-title">安全可靠</h3>
                        <p class="feature-description">企业级安全保障，为您的数据提供全方位防护。</p>
                    </div>
                    <div class="feature-card element" data-element="3">
                        <div class="feature-icon">📊</div>
                        <h3 class="feature-title">数据分析</h3>
                        <p class="feature-description">强大的分析工具，助您洞察业务趋势。</p>
                    </div>
                </div>

                <div class="content-section">
                    <h2 class="section-title">最新动态</h2>
                    <article class="article element" data-element="4">
                        <h3 class="article-title">人工智能革新产业未来</h3>
                        <div class="article-meta">
                            <span>发布于 2024-03-21</span>
                            <span>阅读时间 5 分钟</span>
                        </div>
                        <img src="https://picsum.photos/800/400" alt="AI Technology" class="article-image">
                        <p class="article-content">人工智能技术正在重塑各个行业，从医疗保健到金融服务，AI 的应用范围不断扩大。本文将深入探讨 AI 技术如何改变我们的工作方式和生活方式。</p>
                        <div class="tags">
                            <span class="tag">人工智能</span>
                            <span class="tag">技术创新</span>
                            <span class="tag">数字转型</span>
                        </div>
                    </article>

                    <article class="article element" data-element="5">
                        <h3 class="article-title">云计算技术发展趋势</h3>
                        <div class="article-meta">
                            <span>发布于 2024-03-20</span>
                            <span>阅读时间 4 分钟</span>
                        </div>
                        <p class="article-content">随着数字化转型的深入，云计算技术在企业中的应用越来越广泛。本文将为您解析云计算的最新发展趋势和最佳实践。</p>
                        <div class="tags">
                            <span class="tag">云计算</span>
                            <span class="tag">企业服务</span>
                            <span class="tag">技术趋势</span>
                        </div>
                    </article>
                </div>

                <div class="newsletter-section">
                    <h3 class="newsletter-title">订阅我们的新闻简报</h3>
                    <p class="newsletter-description">及时了解最新技术动态和行业见解，每周精选内容直达您的邮箱。</p>
                    <a href="#" class="cta-button">立即订阅</a>
                </div>

                <div class="toolbar" id="toolbar">
                    <div class="toolbar-title" id="toolbarDragHandle">Kimmy 猜你想</div>
                    <button><span class="icon">✍️</span> 修改文本</button>
                    <button><span class="icon">🔗</span> 修改链接</button>
                    <div class="toolbar-divider">
                        <svg xmlns="http://www.w3.org/2000/svg" width="148" height="2" viewBox="0 0 148 2" fill="none">
                          <path d="M0 1H148" stroke="black" stroke-opacity="0.3" stroke-linejoin="round" stroke-dasharray="1 3"/>
                        </svg>
                    </div>
                    <button class="delete-button"><span class="icon">🗑️</span> 删除文本</button>
                    <!-- 添加箭头SVG -->
                    <div class="toolbar-arrow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="32" viewBox="0 0 13 32" fill="none">
                            <path d="M11.6226 13.7987C12.905 14.9861 12.905 17.0139 11.6226 18.2013L3.09424 26.0979C1.416 27.6518 0.323455 29.7358 1.46226e-06 32L2.86102e-06 -6.11959e-07C0.323455 2.26418 1.416 4.34815 3.09424 5.90207L11.6226 13.7987Z" fill="white"/>
                        </svg>
                    </div>
                </div>
                
                <!-- 将IP人物单独放置 -->
                <div class="ip-character-container" id="ipCharacterContainer">
                    <img src="resource/IP人物.png" alt="IP角色" id="ipCharacter">
                </div>
            </div>
        </div>
        <div class="right-panel">
            <!-- 右侧面板顶部 -->
            <div class="right-panel-header">
                <img src="resource/credit.png" alt="Credits" class="credit-icon" style="width: 72px; height: 36px;">
                <button class="upgrade-button">
                    Upgrade
                </button>
                <img src="resource/help.svg" alt="Help" class="help-icon">
            </div>
            
            <!-- 对话记录区域 -->
            <div class="chat-history" id="chatHistory">
                <!-- 这里将显示对话记录 -->
            </div>
            
            <div class="input-container">
                <div class="suggestion-panel" id="suggestionPanel">
                    <div class="suggestion-header">
                        <span class="icon">✨</span>
                        <span>Suggestion</span>
                    </div>
                    <div class="suggestion-item">增加元素的文本大小</div>
                    <div class="suggestion-item">增加元素之间的间距</div>
                    <div class="suggestion-item">减小背景透明度</div>
                </div>
                <div class="input-wrapper" id="inputWrapper">
                    <div id="inputTagContainer" class="input-tag-container"></div>
                    <div class="input-content-container">
                        <textarea id="mainInput" class="input-text-area" placeholder="按任意键聚焦..." rows="1"></textarea>
                    </div>
                    <div class="input-actions">
                        <div class="input-left-actions">
                            <button class="action-button">➕</button>
                            <button class="action-button">📎</button>
                        </div>
                        <div class="input-right-actions">
                            <button class="send-button">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const leftPanel = document.getElementById('leftPanel');
        const toolbar = document.getElementById('toolbar');
        const mainInput = document.getElementById('mainInput');
        const suggestionPanel = document.getElementById('suggestionPanel');
        const inputWrapper = document.getElementById('inputWrapper');
        const inputTagContainer = document.getElementById('inputTagContainer');
        let lastMousePosition = { x: 0, y: 0 };
        let lastMoveTime = Date.now();
        let isToolbarVisible = false;
        let selectedElement = null;
        let canAcceptInput = true; // 移到全局作用域，使其可以被多个函数访问
        
        // 鼠标移动跟踪相关变量
        let lastToolbarHideTime = 0; // 记录工具栏最后一次隐藏的时间
        let mouseMovementTracking = false; // 是否正在跟踪鼠标移动
        let startTrackPosition = { x: 0, y: 0 }; // 开始跟踪时的位置
        
        // 菜单自动隐藏相关变量
        let isSecondAppearance = false; // 标记菜单是否是二次出现
        let leftPanelLeaveTimer = null; // 处理鼠标离开左侧面板的计时器
        
        // 拖动工具栏相关变量
        let isDragging = false; // 是否正在拖动工具栏
        let dragOffset = { x: 0, y: 0 }; // 鼠标点击位置与工具栏左上角的偏移
        let lastToolbarPosition = null; // 保存工具栏的最后位置
        let hasCustomPosition = false; // 标记工具栏是否有自定义位置
        let isTextEditMode = false; // 添加文本编辑模式标志

        // 初始化页面，给所有可选中元素添加属性
        function initSelectableElements() {
            // 获取所有可能被选中的元素，排除顶部栏元素
            const selectableElements = leftPanel.querySelectorAll('.panel-content img, .panel-content .feature-icon, .panel-content h1, .panel-content h2, .panel-content h3, .panel-content p, .panel-content .tag, .panel-content .article-image, .panel-content .cta-button');
            
            selectableElements.forEach(el => {
                // 标记元素为可选中
                el.setAttribute('data-selectable', 'true');
                
                // 阻止原生点击事件
                el.addEventListener('click', preventDefaultClick, true);
            });
            
            // 对按钮进行特殊处理，防止内部元素被单独选中，排除顶部栏按钮
            const buttons = leftPanel.querySelectorAll('.panel-content button, .panel-content .cta-button, .panel-content a');
            buttons.forEach(btn => {
                btn.querySelectorAll('*').forEach(child => {
                    child.setAttribute('data-button-child', 'true');
                });
            });
            
            // 初始化DOM加载完成后，设置全局监听器确保标签显示正确
            document.addEventListener('DOMContentLoaded', () => {
                // 监听文档点击，确保标签显示状态与选中元素一致
                document.addEventListener('click', () => {
                    // 简单延迟确保其他点击处理完成
                    setTimeout(() => {
                        // 如果有选中元素但标签未显示且输入框有焦点，则显示标签
                        if (selectedElement && !inputTagContainer.classList.contains('visible') && 
                            document.activeElement === mainInput) {
                            generateInputTag();
                            inputTagContainer.classList.add('visible');
                        }
                    }, 50);
                });
                
                // 删除全局键盘事件监听（任意键自动聚焦输入框的功能）
                /*
                document.addEventListener('keydown', (e) => {
                    // 忽略一些特殊按键如ESC(已经处理)、Tab、Alt、Ctrl等
                    if (e.key === 'Escape' || e.key === 'Tab' || e.key === 'Alt' || 
                        e.key === 'Control' || e.key === 'Meta' || e.key === 'Shift') {
                        return;
                    }
                    
                    // 如果当前焦点不在输入框上且不在右侧面板内
                    const rightPanel = document.querySelector('.right-panel');
                    if (document.activeElement !== mainInput && !rightPanel.contains(document.activeElement)) {
                        e.preventDefault(); // 阻止默认行为
                        e.stopPropagation(); // 阻止事件冒泡
                        
                        // 延迟聚焦输入框，确保当前按键事件完全结束
                        let currentValue = mainInput.value;
                        setTimeout(() => {
                            focusInputWithAnimation();
                            // 恢复原始值，防止按键字符被输入
                            mainInput.value = currentValue;
                        }, 10);
                    }
                });
                */
            });
        }
        
        // 阻止原生点击事件
        function preventDefaultClick(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
        
        // 判断元素是否可选中
        function isSelectableElement(element) {
            // 最外层容器不可选中
            if (element === leftPanel) return false;
            
            // 顶部栏元素不可选中
            if (element.closest('.top-bar')) return false;
            
            // 如果是按钮内的子元素，返回按钮元素
            if (element.getAttribute('data-button-child') === 'true') {
                return element.closest('button, .cta-button, a');
            }
            
            // 具有data-selectable属性的元素或element类的元素可选中
            if (element.getAttribute('data-selectable') === 'true' || element.classList.contains('element')) {
                return element;
            }
            
            // 否则尝试查找父级可选中元素
            return element.closest('[data-selectable="true"], .element');
        }

        // 处理点击事件，处理选中逻辑
        leftPanel.addEventListener('click', (e) => {
            e.preventDefault(); // 阻止默认点击动作
            
            const clickedElement = e.target;
            const selectableElement = isSelectableElement(clickedElement);
            
            // 点击选中处理
            if (selectableElement) {
                // 如果点击的是已选中元素，则取消选中
                if (selectedElement === selectableElement) {
                    deselectElement(false, true); // 强制取消选中
                    return;
                }
                
                // 如果当前输入框有焦点且已有选中元素，不要立即清除标签显示
                const keepTagVisible = document.activeElement === mainInput && selectedElement;
                
                // 选中新元素
                selectElement(selectableElement, keepTagVisible);
                
                // 如果输入框已经聚焦，确保标签显示
                if (document.activeElement === mainInput) {
                    // 确保正确显示标签
                    setTimeout(() => {
                        if (selectedElement && !inputTagContainer.classList.contains('visible')) {
                            generateInputTag();
                            inputTagContainer.classList.add('visible');
                        }
                    }, 50);
                }
            } else if (clickedElement === leftPanel || clickedElement.closest('.hero-section') === leftPanel.querySelector('.hero-section')) {
                // 点击面板背景或顶部区域，取消选中
                deselectElement(false, true); // 强制取消选中
            }
        }, true); // 捕获阶段处理，确保先于其他事件处理

        // 选中元素函数，添加keepTagVisible参数
        function selectElement(element, keepTagVisible = false) {
            // 检查右侧面板
            const rightPanel = document.querySelector('.right-panel');
            const isFromRightPanel = rightPanel.contains(document.activeElement);
            
            // 如果操作不是来自右侧面板，则清除之前的选中状态
            if (!isFromRightPanel) {
                deselectElement(false); // 不隐藏工具栏
            }
            
            // 设置新的选中状态
            element.classList.add('selected');
            selectedElement = element;
            
            // 检查父元素是否为具有element类的容器元素，为容器添加选中效果
            const parentElement = element.closest('.element');
            if (parentElement && parentElement !== element) {
                parentElement.classList.add('parent-of-selected');
            }
            
            // 更新缩略图
            const thumbnail = document.querySelector('.thumbnail');
            if (thumbnail) {
                // 尝试获取背景颜色或其他视觉属性
                let bgColor = getComputedStyle(element).backgroundColor;
                if (bgColor === 'rgba(0, 0, 0, 0)' || bgColor === 'transparent') {
                    bgColor = '#e0e0e0'; // 默认颜色
                }
                thumbnail.style.backgroundColor = bgColor;
            }
            
            // 如果操作不是来自右侧面板，则显示工具栏
            if (!isFromRightPanel) {
                const rect = element.getBoundingClientRect();
                // 当选择新元素时，我们仍然保持自定义位置
                showToolbar(rect, false); // 初始选中不是二次出现
            }
            
            // 如果输入框处于焦点状态，触发suggestion面板
            if (document.activeElement === mainInput) {
                suggestionPanel.classList.add('visible');
            }
            
            // 标签处理逻辑：在切换选中元素时保持标签可见
            if (keepTagVisible && inputTagContainer.classList.contains('visible')) {
                // 不移除visible类，直接更新内容
                inputTagContainer.innerHTML = '';
                generateInputTag();
            } else {
                // 常规标签显示逻辑
                inputTagContainer.classList.remove('hiding');
                inputTagContainer.classList.remove('visible');
                inputTagContainer.innerHTML = '';
                generateInputTag();
                
                // 如果输入框是焦点状态，确保标签显示
                if (document.activeElement === mainInput) {
                    setTimeout(() => {
                        if (selectedElement && !inputTagContainer.classList.contains('visible')) {
                            inputTagContainer.classList.add('visible');
                        }
                    }, 50);
                }
            }
        }
        
        // 取消选中元素函数
        function deselectElement(hideToolbarFlag = false, forceDeselect = false) {
            // 如果不是强制取消选中，检查焦点是否在右侧面板
            if (!forceDeselect) {
                const rightPanel = document.querySelector('.right-panel');
                // 如果当前焦点在右侧面板内，不执行取消选中
                if (rightPanel.contains(document.activeElement)) {
                    return;
                }
            }
            
            if (selectedElement) {
                selectedElement.classList.remove('selected');
                
                // 移除父元素的选中样式
                const parentElement = selectedElement.closest('.element');
                if (parentElement && parentElement !== selectedElement) {
                    parentElement.classList.remove('parent-of-selected');
                }
                
                // 移除所有可能有parent-of-selected类的元素
                document.querySelectorAll('.parent-of-selected').forEach(el => {
                    el.classList.remove('parent-of-selected');
                });
                
                selectedElement = null;
                
                // 始终隐藏工具栏，无论hideToolbarFlag参数如何
                hideToolbar();
                
                // 不再需要单独隐藏建议面板，因为已集成到标签中
                // suggestionPanel.classList.remove('visible');
                
                // 标签处理：由于正在切换选中元素时不应隐藏标签
                // 检查是否是在选中新元素的过程中（如点击事件冒泡阶段）
                const isClickEvent = event && event.type === 'click';
                
                // 只有在非点击事件或强制取消选中时才隐藏标签
                if (!isClickEvent || forceDeselect) {
                    // 立即清空标签容器的内容，然后再添加隐藏动画
                    if (inputTagContainer.classList.contains('visible')) {
                        inputTagContainer.classList.add('hiding');
                        inputTagContainer.classList.remove('visible');
                        
                        // 移除高度类
                        inputWrapper.classList.remove('with-tag');
                        
                        // 立即设置为0高度，确保不占用空间
                        inputTagContainer.style.height = '0';
                        inputTagContainer.style.minHeight = '0';
                        inputTagContainer.style.padding = '0';
                        
                        // 动画结束后清空内容
                        setTimeout(() => {
                            inputTagContainer.classList.remove('hiding');
                            inputTagContainer.innerHTML = '';
                        }, 300);
                    }
                }
            }
        }

        // 按ESC键取消选中
        document.addEventListener('keydown', (e) => {
            // 获取右侧面板
            const rightPanel = document.querySelector('.right-panel');
            
            // 如果按ESC键且焦点不在右侧面板内，则取消选中
            if (e.key === 'Escape' && !rightPanel.contains(document.activeElement)) {
                // 取消选中但不自动隐藏工具栏，并强制取消选中
                if (selectedElement) {
                    deselectElement(false, true);
                    // 按ESC键同时重置工具栏位置
                    resetToolbarPosition();
                }
                return;
            }
            
            // 删除下面的代码，不再自动聚焦输入框
            /*
            // 其他键的行为保持不变 - 聚焦输入框
            if (e.target !== mainInput && !rightPanel.contains(e.target)) {
                mainInput.focus();
            }
            */
        });

        // 显示工具栏函数
        function showToolbar(rect, secondAppearance = false) {
            // 定位工具栏
            toolbar.style.display = 'block';
            
            // 清空工具栏按钮
            clearToolbarButtons();
            
            // 添加基于选中元素类型的按钮
            addToolbarButtonsByElementType();
            
            // 如果工具栏有自定义位置，使用上次的位置
            if (hasCustomPosition && lastToolbarPosition) {
                toolbar.style.top = lastToolbarPosition.top + 'px';
                toolbar.style.left = lastToolbarPosition.left + 'px';
            } else {
                // 否则使用默认计算方式
                // 根据窗口大小和元素位置计算最合适的位置
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                // 获取左侧面板的位置信息
                const leftPanelRect = leftPanel.getBoundingClientRect();
                const containerRect = document.querySelector('.container').getBoundingClientRect();
                
                // 优先显示在元素右侧
                let left = rect.right + 10;
                let top = rect.top;
                
                // 计算工具栏的尺寸
                const toolbarWidth = 220; // 与CSS中定义的宽度一致
                const toolbarHeight = 180; // 估计高度
                
                // 获取右侧面板的位置
                const rightPanelRect = document.querySelector('.right-panel').getBoundingClientRect();
                
                // 检查右侧是否有足够空间
                if (left + toolbarWidth > rightPanelRect.left - 10) {
                    // 如果右侧空间不够，尝试放在左侧
                    left = rect.left - toolbarWidth - 10;
                    
                    // 如果左侧也没有足够空间，则放在下方居中
                    if (left < leftPanelRect.left + 20) {
                        left = rect.left + (rect.width - toolbarWidth) / 2;
                        top = rect.bottom + 10;
                        
                        // 确保不会超出左边界
                        if (left < leftPanelRect.left + 20) left = leftPanelRect.left + 20;
                        // 确保不会超出右边界
                        if (left + toolbarWidth > rightPanelRect.left - 10) {
                            left = rightPanelRect.left - toolbarWidth - 10;
                        }
                    }
                }
                
                // 确保工具栏不会超出底部边界
                if (top + toolbarHeight > containerRect.bottom - 20) {
                    top = Math.max(leftPanelRect.top + 20, containerRect.bottom - toolbarHeight - 20);
                }
                
                // 确保工具栏不会超出顶部边界
                if (top < leftPanelRect.top + 20) {
                    top = leftPanelRect.top + 20;
                }
                
                toolbar.style.top = top + 'px';
                toolbar.style.left = left + 'px';
            }
            
            isToolbarVisible = true;
            isSecondAppearance = secondAppearance;
            
            // 如果有计时器，清除它
            if (leftPanelLeaveTimer) {
                clearTimeout(leftPanelLeaveTimer);
                leftPanelLeaveTimer = null;
            }
            
            // 显示IP人物图像
            showIpCharacter();
            
            // 显示工具栏不再影响标签的显示状态
            // 标签的显示由selectElement和输入框焦点状态控制
        }
        
        // 显示IP人物图像
        function showIpCharacter() {
            const ipCharacterContainer = document.getElementById('ipCharacterContainer');
            if (!ipCharacterContainer) return;
            
            // 显示IP人物容器
            ipCharacterContainer.style.display = 'block';
            
            // 获取工具栏的位置
            const toolbarRect = toolbar.getBoundingClientRect();
            
            // 将IP人物定位到工具栏右侧
            ipCharacterContainer.style.top = (toolbarRect.top + toolbarRect.height / 2 + 30) + 'px';
            ipCharacterContainer.style.left = (toolbarRect.right + 20) + 'px';
        }

        // 隐藏工具栏函数
        function hideToolbar() {
            toolbar.style.display = 'none';
            isToolbarVisible = false;
            isSecondAppearance = false;
            
            // 记录工具栏隐藏时间
            lastToolbarHideTime = Date.now();
            // 重置移动跟踪状态
            mouseMovementTracking = true;
            startTrackPosition = lastMousePosition;
            
            // 如果有计时器，清除它
            if (leftPanelLeaveTimer) {
                clearTimeout(leftPanelLeaveTimer);
                leftPanelLeaveTimer = null;
            }
            
            // 隐藏IP人物
            const ipCharacterContainer = document.getElementById('ipCharacterContainer');
            if (ipCharacterContainer) {
                ipCharacterContainer.style.display = 'none';
            }
            
            // 工具栏隐藏不再影响标签显示状态
            // 只有在明确取消选择元素时才会隐藏标签
        }

        // 重置工具栏位置函数
        function resetToolbarPosition() {
            hasCustomPosition = false;
            lastToolbarPosition = null;
        }

        // 鼠标移动处理逻辑
        leftPanel.addEventListener('mousemove', (e) => {
            const currentTime = Date.now();
            const currentPosition = { x: e.clientX, y: e.clientY };
            
            // 如果工具栏不可见且选中了元素，检测鼠标移动距离
            if (!isToolbarVisible && selectedElement) {
                // 如果还没开始跟踪移动，开始跟踪
                if (!mouseMovementTracking) {
                    mouseMovementTracking = true;
                    startTrackPosition = currentPosition;
                    lastMoveTime = currentTime;
                } else {
                    // 计算移动距离
                    const deltaX = Math.abs(currentPosition.x - startTrackPosition.x);
                    const deltaY = Math.abs(currentPosition.y - startTrackPosition.y);
                    const timePassed = currentTime - lastToolbarHideTime;
                    
                    // 如果距离工具栏隐藏已超过350ms，且X或Y轴移动超过50px，显示工具栏
                    if (timePassed > 350 && (deltaX > 30 || deltaY > 30)) {
                        const rect = selectedElement.getBoundingClientRect();
                        // 这里是二次出现（用户移入左侧区域触发）
                        showToolbar(rect, true);
                        mouseMovementTracking = false;
                    }
                }
            }
            
            lastMousePosition = currentPosition;
        });
        
        // 初始化鼠标位置
        leftPanel.addEventListener('mouseenter', (e) => {
            lastMousePosition = { x: e.clientX, y: e.clientY };
            lastMoveTime = Date.now();
            
            // 如果有计时器，清除它（取消自动隐藏）
            if (leftPanelLeaveTimer) {
                clearTimeout(leftPanelLeaveTimer);
                leftPanelLeaveTimer = null;
            }
            
            if (!isToolbarVisible && selectedElement) {
                mouseMovementTracking = true;
                startTrackPosition = { x: e.clientX, y: e.clientY };
            }
        });

        // 点击其他区域隐藏工具栏
        document.addEventListener('click', (e) => {
            // 检查点击是否发生在右侧面板内，如果是则不做任何操作
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel.contains(e.target)) {
                return; // 如果点击在右侧面板内，不执行任何操作
            }
            
            // 处理左侧面板区域的点击
            if (!e.target.closest('.toolbar') && !e.target.closest('.element') && !isSelectableElement(e.target)) {
                // 如果点击的不是工具栏、元素或可选择元素，强制取消选中
                deselectElement(false, true);
            }
        });
        
        // 鼠标离开左侧面板时的处理
        leftPanel.addEventListener('mouseleave', () => {
            // 如果正在拖动工具栏，不执行自动隐藏
            if (isDragging) return;
            
            // 只隐藏工具栏，不影响选中状态和标签
            if (isSecondAppearance && isToolbarVisible) {
                // 清除之前的计时器（如果有）
                if (leftPanelLeaveTimer) {
                    clearTimeout(leftPanelLeaveTimer);
                }
                
                // 设置新的计时器
                leftPanelLeaveTimer = setTimeout(() => {
                    // 仅隐藏工具栏，不取消选中状态
                    if (isToolbarVisible) {
                        toolbar.style.display = 'none';
                        isToolbarVisible = false;
                        isSecondAppearance = false;
                        
                        // 记录工具栏隐藏时间
                        lastToolbarHideTime = Date.now();
                        // 重置移动跟踪状态
                        mouseMovementTracking = true;
                        startTrackPosition = lastMousePosition;
                        
                        // 隐藏IP人物
                        const ipCharacterContainer = document.getElementById('ipCharacterContainer');
                        if (ipCharacterContainer) {
                            ipCharacterContainer.style.display = 'none';
                        }
                    }
                    
                    leftPanelLeaveTimer = null;
                }, 100);
            }
        });

        // 检查鼠标是否在元素上方
        function isMouseOverElement(element) {
            if (!element) return false;
            const rect = element.getBoundingClientRect();
            return (
                lastMousePosition.x >= rect.left &&
                lastMousePosition.x <= rect.right &&
                lastMousePosition.y >= rect.top &&
                lastMousePosition.y <= rect.bottom
            );
        }

        // 阻止右侧面板点击事件冒泡，确保不会影响左侧选中元素
        const rightPanel = document.querySelector('.right-panel');
        rightPanel.addEventListener('click', (e) => {
            // 阻止事件冒泡，避免触发document上的点击事件处理
            e.stopPropagation();
        });
        
        // 工具栏拖动功能
        function initToolbarDrag() {
            const dragHandle = document.getElementById('toolbarDragHandle');
            
            // 鼠标按下开始拖动
            dragHandle.addEventListener('mousedown', (e) => {
                // 防止触发其他点击事件
                e.preventDefault();
                e.stopPropagation();
                
                // 标记开始拖动
                isDragging = true;
                
                // 计算鼠标点击位置与工具栏左上角的偏移
                const toolbarRect = toolbar.getBoundingClientRect();
                dragOffset.x = e.clientX - toolbarRect.left;
                dragOffset.y = e.clientY - toolbarRect.top;
                
                // 修改工具栏样式
                toolbar.style.transition = 'none'; // 取消过渡效果，使拖动更平滑
                toolbar.classList.add('dragging'); // 添加拖动时的视觉效果
            });
            
            // 双击标题栏重置工具栏位置
            dragHandle.addEventListener('dblclick', () => {
                if (selectedElement) {
                    resetToolbarPosition();
                    const rect = selectedElement.getBoundingClientRect();
                    showToolbar(rect, false);
                }
            });
            
            // 鼠标移动过程中移动工具栏
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    // 计算新位置
                    const newLeft = e.clientX - dragOffset.x;
                    const newTop = e.clientY - dragOffset.y;
                    
                    // 获取窗口尺寸和工具栏尺寸
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    const toolbarRect = toolbar.getBoundingClientRect();
                    const toolbarWidth = toolbarRect.width;
                    const toolbarHeight = toolbarRect.height;
                    
                    // 边界检查：确保工具栏不会超出视图
                    let finalLeft = newLeft;
                    let finalTop = newTop;
                    
                    // 左边界检查
                    if (finalLeft < 10) finalLeft = 10;
                    // 右边界检查（至少保留20px在视图内）
                    if (finalLeft + toolbarWidth > windowWidth - 10) {
                        finalLeft = windowWidth - toolbarWidth - 10;
                    }
                    // 上边界检查
                    if (finalTop < 10) finalTop = 10;
                    // 下边界检查
                    if (finalTop + toolbarHeight > windowHeight - 10) {
                        finalTop = windowHeight - toolbarHeight - 10;
                    }
                    
                    // 更新工具栏位置
                    toolbar.style.left = finalLeft + 'px';
                    toolbar.style.top = finalTop + 'px';
                    
                    // 同时更新IP人物位置
                    updateIpCharacterPosition();
                }
            });
            
            // 鼠标释放结束拖动
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    toolbar.style.transition = 'all 0.2s ease'; // 恢复过渡效果
                    toolbar.classList.remove('dragging'); // 移除拖动时的视觉效果
                    
                    // 保存工具栏的当前位置
                    const toolbarRect = toolbar.getBoundingClientRect();
                    lastToolbarPosition = {
                        top: toolbarRect.top,
                        left: toolbarRect.left
                    };
                    hasCustomPosition = true;
                    
                    // 更新IP人物位置
                    updateIpCharacterPosition();
                }
            });
            
            // 鼠标离开窗口也结束拖动
            document.addEventListener('mouseleave', () => {
                if (isDragging) {
                    isDragging = false;
                    toolbar.style.transition = 'all 0.2s ease';
                    toolbar.classList.remove('dragging'); // 移除拖动时的视觉效果
                    
                    // 保存工具栏的当前位置
                    const toolbarRect = toolbar.getBoundingClientRect();
                    lastToolbarPosition = {
                        top: toolbarRect.top,
                        left: toolbarRect.left
                    };
                    hasCustomPosition = true;
                }
            });
        }
        
        // 初始化页面，给所有可选中元素添加属性
        function initPage() {
            // 找到所有可选中的元素，添加样式和点击事件
            const selectableElements = document.querySelectorAll('.article-title, .article-content, .article-image, .feature-card, .feature-title, .feature-content, .feature-icon, h1, h2, h3, .article, button, .cta-button, a');
            
            selectableElements.forEach(el => {
                el.classList.add('selectable');
                
                // 添加双击事件处理
                el.addEventListener('dblclick', (e) => {
                    // 如果元素是文本类型，直接进入文本编辑模式，不唤出工具栏
                    if (el.tagName === 'P' || el.tagName === 'H1' || el.tagName === 'H2' || 
                        el.tagName === 'H3' || el.classList.contains('article-title') || 
                        el.classList.contains('article-content') || el.classList.contains('feature-title') || 
                        el.classList.contains('feature-content') || el.tagName === 'BUTTON' || 
                        el.tagName === 'A' || el.classList.contains('cta-button')) {
                        
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // 先选中元素
                        selectElement(el, false);
                        
                        // 进入文本编辑模式
                        isTextEditMode = true;
                        
                        // 设置为可编辑
                        el.contentEditable = true;
                        el.focus();
                        
                        // 选中文本内容
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(el);
                        selection.removeAllRanges();
                        selection.addRange(range);
                        
                        // 不显示工具栏
                        hideToolbar();
                    }
                });
                
                // 阻止默认点击
                el.addEventListener('click', preventDefaultClick, true);
            });
            
            // 初始化其他功能
            initToolbarDrag();
            
            // 隐藏加载动画
            document.querySelector('.loading-overlay').style.display = 'none';
        }
        
        // 页面加载完成后执行初始化
        window.addEventListener('DOMContentLoaded', initPage);
        
        // 初始化全局键盘事件监听
        function initGlobalKeyboardListener() {
            document.addEventListener('keydown', (e) => {
                const mainInput = document.getElementById('mainInput');
                const rightPanel = document.querySelector('.right-panel');
                
                // 如果处于文本编辑模式，不自动聚焦到输入框
                // 并检查是否按下Enter键退出编辑模式
                if (isTextEditMode) {
                    // 处理Enter键退出编辑模式
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // 阻止默认行为（防止换行）
                        
                        // 退出编辑模式
                        if (selectedElement) {
                            // 取消可编辑状态
                            selectedElement.contentEditable = false;
                            isTextEditMode = false;
                            
                            // 取消文本选择
                            window.getSelection().removeAllRanges();
                            
                            // 保持元素的选中状态，可以再次使用工具栏
                            selectedElement.classList.add('selected');
                        }
                    }
                    return; // 在编辑模式下不执行后续的键盘事件处理
                }
                
                // 忽略一些特殊按键如ESC、Tab、Alt、Ctrl等
                if (e.key === 'Escape' || e.key === 'Tab' || e.key === 'Alt' || 
                    e.key === 'Control' || e.key === 'Meta' || e.key === 'Shift') {
                    return;
                }
                
                // 如果当前焦点不在输入框上且不在右侧面板内的其他输入元素中
                if (document.activeElement !== mainInput && 
                    !(rightPanel.contains(document.activeElement) && 
                      (document.activeElement.tagName === 'INPUT' || 
                       document.activeElement.tagName === 'TEXTAREA'))) {
                    
                    e.preventDefault(); // 阻止默认行为
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    // 聚焦输入框，但不传递当前按键
                    focusInputWithAnimation();
                }
            });
        }
        
        // 添加消息到对话记录
        function addMessage(text, type) {
            const chatHistory = document.getElementById('chatHistory');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            
            chatHistory.appendChild(messageElement);
            
            // 滚动到底部
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // 隐藏建议面板
            suggestionPanel.classList.remove('visible');
        }
        
        // 聚焦输入框并应用动画效果
        function focusInputWithAnimation() {
            // 聚焦输入框
            mainInput.focus();
            
            // 添加动画效果
            inputWrapper.classList.add('input-focus-animation');
            inputWrapper.classList.add('focused');
            
            // 动画结束后移除类
            setTimeout(() => {
                inputWrapper.classList.remove('input-focus-animation');
            }, 600);
        }
        
        // 生成输入框标签
        function generateInputTag() {
            if (!selectedElement) {
                // 确保标签容器完全隐藏且不占用空间
                inputTagContainer.classList.remove('visible');
                inputTagContainer.classList.remove('hiding');
                inputTagContainer.innerHTML = '';
                inputTagContainer.style.height = '0';
                inputTagContainer.style.minHeight = '0';
                inputTagContainer.style.padding = '0';
                inputWrapper.classList.remove('with-tag');
                return false;
            }
            
            // 清空标签容器
            inputTagContainer.innerHTML = '';
            
            // 根据选中元素类型确定图标和内容
            let icon = '📄';
            let content = 'Text';
            
            if (selectedElement.tagName === 'IMG' || selectedElement.classList.contains('article-image')) {
                icon = '🖼️';
                content = 'Img';
            } else if (selectedElement.classList.contains('feature-icon')) {
                icon = '🔣';
                content = 'Icon';
            } else if (selectedElement.tagName === 'H1' || selectedElement.tagName === 'H2' || 
                      selectedElement.tagName === 'H3' || selectedElement.classList.contains('article-title') ||
                      selectedElement.classList.contains('feature-title')) {
                icon = '📝';
                content = 'Title';
            } else if (selectedElement.tagName === 'P' || selectedElement.classList.contains('article-content')) {
                icon = '📄';
                content = 'Text';
            } else if (selectedElement.classList.contains('tag')) {
                icon = '🏷️';
                content = 'Tag';
            } else if (selectedElement.classList.contains('cta-button') || 
                      selectedElement.tagName === 'BUTTON' || 
                      selectedElement.tagName === 'A') {
                icon = '🔘';
                content = 'Button';
            } else if (selectedElement.classList.contains('feature-card')) {
                icon = '🃏';
                content = 'Card';
            } else if (selectedElement.classList.contains('article')) {
                icon = '📰';
                content = 'Article';
            }
            
            // 创建左侧标签元素
            const tagElement = document.createElement('div');
            tagElement.className = 'input-tag';
            tagElement.innerHTML = `<span class="icon">${icon}</span> ${content}`;
            
            // 创建建议容器
            const suggestionContainer = document.createElement('div');
            suggestionContainer.className = 'suggestion-container';
            
            // 添加标题
            const suggestionTitle = document.createElement('div');
            suggestionTitle.className = 'suggestion-title';
            suggestionTitle.textContent = 'Suggestion';
            suggestionTitle.style.color = '#ffffff7d';
            suggestionTitle.style.fontSize = '14px';
            suggestionTitle.style.marginBottom = '8px';
            suggestionContainer.appendChild(suggestionTitle);
            
            // 创建建议滑块容器
            const suggestionSlider = document.createElement('div');
            suggestionSlider.className = 'suggestion-slider';
            
            // 添加建议选项
            const suggestions = [
                '添加图片悬停效果，如轻微放大或阴影',
                '调整图片亮度或对比度以突出主体',
                '给图片添加细边框或内部阴影'
            ];
            
            // 根据选中元素类型提供不同的建议
            let elementSuggestions = suggestions;
            
            if (content === 'Text' || content === 'Title') {
                elementSuggestions = [
                    '增加文本大小',
                    '改变文本颜色',
                    '调整行间距'
                ];
            } else if (content === 'Button') {
                elementSuggestions = [
                    '改变按钮颜色',
                    '添加悬停动画',
                    '调整按钮圆角'
                ];
            } else if (content === 'Card') {
                elementSuggestions = [
                    '添加卡片阴影',
                    '改变卡片背景色',
                    '为卡片添加边框'
                ];
            }
            
            // 添加建议到滑块
            elementSuggestions.forEach((text, index) => {
                const option = document.createElement('div');
                option.className = 'suggestion-option';
                option.textContent = text;
                
                // 第一个选项默认为活动状态
                if (index === 0) {
                    option.classList.add('active');
                }
                
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 处理建议点击事件
                    addMessage(text, 'user');
                    
                    // 模拟AI回复
                    setTimeout(() => {
                        addMessage('收到您的建议请求，我将根据"' + text + '"优化内容...', 'ai');
                    }, 1000);
                    
                    // 清空输入框
                    mainInput.value = '';
                });
                suggestionSlider.appendChild(option);
            });
            
            // 将滑块添加到建议容器
            suggestionContainer.appendChild(suggestionSlider);
            
            // 创建右侧关闭按钮
            const closeButton = document.createElement('button');
            closeButton.className = 'input-tag-close';
            closeButton.innerHTML = '✕';
            closeButton.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // 点击关闭按钮时，仅取消选中元素，但保持输入框聚焦
                deselectElement(true, true); // 取消选中并隐藏工具栏
                
                // 让输入框保持焦点
                setTimeout(() => {
                    mainInput.focus();
                }, 10);
            });
            
            // 创建顶部容器用于放置标签和关闭按钮
            const topContainer = document.createElement('div');
            topContainer.className = 'tag-top-container';
            topContainer.style.display = 'flex';
            topContainer.style.alignItems = 'center';
            topContainer.style.justifyContent = 'space-between';
            
            // 将标签和关闭按钮添加到顶部容器
            topContainer.appendChild(tagElement);
            topContainer.appendChild(closeButton);
            
            // 添加到标签容器 - 先添加顶部容器，再添加建议容器
            inputTagContainer.appendChild(topContainer);
            inputTagContainer.appendChild(suggestionContainer);
            
            // 显示标签容器
            inputTagContainer.classList.add('visible');
            
            // 确保标签容器高度正确
            setTimeout(() => {
                // 设置为auto以确保显示所有内容
                inputTagContainer.style.height = 'auto';
                
                // 确保输入区域不被压缩
                const inputContentContainer = document.querySelector('.input-content-container');
                if (inputContentContainer) {
                    inputContentContainer.style.minHeight = '67px';
                }
            }, 0);
            
            // 添加高度类
            inputWrapper.classList.add('with-tag');
            inputWrapper.style.height = 'auto';
            
            return true; // 返回成功标志
        }
        
        // 初始化输入框焦点处理
        function initInputFocus() {
            const inputContainer = document.querySelector('.input-container');
            const textArea = document.getElementById('mainInput');
            // 移除局部变量定义，使用全局变量
            
            // 自动调整文本区域高度
            function adjustTextAreaHeight() {
                textArea.style.height = 'auto';
                const newHeight = Math.min(textArea.scrollHeight, 120); // 最大高度限制
                textArea.style.height = newHeight + 'px';
                
                // 确保input-content-container保持合适的高度
                const inputContentContainer = document.querySelector('.input-content-container');
                if (inputContentContainer) {
                    inputContentContainer.style.height = 'auto';
                    inputContentContainer.style.minHeight = '67px';
                }
            }
            
            // 监听输入事件调整高度
            textArea.addEventListener('input', (e) => {
                // 如果不能接受输入，阻止输入事件
                if (!canAcceptInput) {
                    e.preventDefault();
                    textArea.value = ''; // 清空输入
                    return;
                }
                
                adjustTextAreaHeight();
                
                // 根据输入内容显示或隐藏建议面板
                if (selectedElement) {
                    const suggestionContainer = document.querySelector('.suggestion-container');
                    if (suggestionContainer) {
                        // 当有内容时隐藏建议容器，无内容时显示建议容器
                        if (textArea.value.trim() !== '') {
                            suggestionContainer.style.display = 'none';
                        } else if (inputWrapper.classList.contains('focused')) {
                            suggestionContainer.style.display = 'flex';
                        }
                    }
                }
            });
            
            // 输入框获得焦点
            textArea.addEventListener('focus', () => {
                inputWrapper.classList.add('focused');
                
                // 设置不能接受输入
                canAcceptInput = false;
                
                // 200ms后才能接受输入
                setTimeout(() => {
                    canAcceptInput = true;
                }, 200);
                
                // 隐藏工具栏
                hideToolbar();
                
                // 如果没有选中元素，确保标签容器完全隐藏
                if (!selectedElement) {
                    inputTagContainer.classList.remove('visible');
                    inputTagContainer.classList.remove('hiding');
                    inputTagContainer.style.height = '0';
                    inputTagContainer.style.minHeight = '0';
                    inputTagContainer.style.padding = '0';
                    inputWrapper.classList.remove('with-tag');
                    return;
                }
                
                if (selectedElement) {
                    // 确保有选中元素时，标签内容始终显示
                    if (!inputTagContainer.classList.contains('visible')) {
                        // 先检查标签内容是否存在，不存在则重新生成
                        if (inputTagContainer.children.length === 0) {
                            generateInputTag();
                        }
                        // 添加显示类
                        inputTagContainer.classList.add('visible');
                        inputTagContainer.classList.remove('hiding');
                        
                        // 确保标签容器高度正确
                        setTimeout(() => {
                            inputTagContainer.style.height = 'auto';
                        }, 0);
                        
                        // 添加高度类
                        inputWrapper.classList.add('with-tag');
                        inputWrapper.style.height = 'auto';
                    }
                    
                    // 确保全部建议项可见
                    setTimeout(() => {
                        const suggestionContainer = document.querySelector('.suggestion-container');
                        if (suggestionContainer) {
                            // 只有在输入框为空时才显示建议
                            if (textArea.value.trim() === '') {
                                suggestionContainer.style.display = 'flex';
                            } else {
                                suggestionContainer.style.display = 'none';
                            }
                        }
                    }, 0);
                }
            });
            
            // 输入框失去焦点
            textArea.addEventListener('blur', () => {
                inputWrapper.classList.remove('focused');
                
                // 如果没有选中元素，确保移除高度类
                if (!selectedElement) {
                    inputWrapper.classList.remove('with-tag');
                } else {
                    // 如果有选中元素，保持标签容器可见但隐藏建议
                    setTimeout(() => {
                        const suggestionContainer = document.querySelector('.suggestion-container');
                        if (suggestionContainer) {
                            suggestionContainer.style.display = 'none';
                        }
                        
                        // 调整标签容器高度，只显示标签部分
                        const tagTopContainer = inputTagContainer.querySelector('.tag-top-container');
                        if (tagTopContainer) {
                            inputTagContainer.style.height = `${tagTopContainer.offsetHeight}px`;
                        }
                    }, 0);
                }
                
                // 如果有选中的元素，自动重新显示工具栏
                if (selectedElement) {
                    const rect = selectedElement.getBoundingClientRect();
                    showToolbar(rect, false); // 这不是二次出现，而是恢复显示
                }
            });
            
            // 监听回车键发送消息
            textArea.addEventListener('keydown', (e) => {
                // 如果不能接受输入，阻止所有键盘事件
                if (!canAcceptInput) {
                    e.preventDefault();
                    return;
                }
                
                // 处理键盘导航 - 修改为处理 suggestion-option 元素
                if (inputTagContainer.classList.contains('visible') && inputWrapper.classList.contains('focused')) {
                    const suggestionOptions = document.querySelectorAll('.suggestion-option');
                    let activeIndex = -1;
                    
                    // 找到当前选中项的索引
                    suggestionOptions.forEach((item, index) => {
                        if (item.classList.contains('active')) {
                            activeIndex = index;
                        }
                    });
                    
                    // 监控删除键和退格键，当输入框内容为空时显示建议
                    if ((e.key === 'Backspace' || e.key === 'Delete') && textArea.value.length <= 1) {
                        setTimeout(() => {
                            const suggestionContainer = document.querySelector('.suggestion-container');
                            if (suggestionContainer && textArea.value.trim() === '') {
                                suggestionContainer.style.display = 'flex';
                                
                                // 重置选中状态
                                if (suggestionOptions.length > 0) {
                                    updateActiveSuggestion(suggestionOptions, 0);
                                }
                            }
                        }, 0);
                    }
                    
                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault(); // 防止光标移动
                            // 向下移动选择
                            activeIndex = (activeIndex + 1) % suggestionOptions.length;
                            updateActiveSuggestion(suggestionOptions, activeIndex);
                            return; // 阻止后续处理
                            
                        case 'ArrowUp':
                            e.preventDefault(); // 防止光标移动
                            // 向上移动选择
                            activeIndex = (activeIndex - 1 + suggestionOptions.length) % suggestionOptions.length;
                            updateActiveSuggestion(suggestionOptions, activeIndex);
                            return; // 阻止后续处理
                            
                        case 'Tab':
                        case 'Enter':
                            // Tab键或Enter键选择当前项
                            if (activeIndex >= 0 && activeIndex < suggestionOptions.length) {
                                e.preventDefault();
                                suggestionOptions[activeIndex].click();
                                return; // 阻止后续处理
                            }
                            break;
                            
                        case 'Escape':
                            // Escape键隐藏建议
                            e.preventDefault();
                            inputWrapper.classList.remove('focused');
                            return; // 阻止后续处理
                    }
                }
                
                // 处理回车键发送消息
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // 阻止默认的换行行为
                    
                    // 否则发送消息
                    if (textArea.value.trim() !== '') {
                        // 获取输入内容
                        const messageText = textArea.value.trim();
                        
                        // 发送消息
                        addMessage(messageText, 'user');
                        
                        // 模拟AI回复
                        setTimeout(() => {
                            addMessage('收到您的消息，我正在处理...', 'ai');
                        }, 1000);
                        
                        // 清空输入框
                        textArea.value = '';
                        adjustTextAreaHeight(); // 重置高度
                    }
                }
            });
            
            // 发送按钮点击事件
            const sendButton = document.querySelector('.send-button');
            if (sendButton) {
                sendButton.addEventListener('click', () => {
                    if (textArea.value.trim() !== '') {
                        // 获取输入内容
                        const messageText = textArea.value.trim();
                        
                        // 发送消息
                        addMessage(messageText, 'user');
                        
                        // 模拟AI回复
                        setTimeout(() => {
                            addMessage('收到您的消息，我正在处理...', 'ai');
                        }, 1000);
                        
                        // 清空输入框
                        textArea.value = '';
                        adjustTextAreaHeight(); // 重置高度
                    }
                });
            }
        }
        
        // 初始化建议项点击事件
        function initSuggestionItems() {
            const suggestionItems = document.querySelectorAll('.suggestion-item');
            
            // 当前选中的建议项索引
            let activeIndex = -1;
            
            // 为每个建议项添加点击事件
            suggestionItems.forEach((item, index) => {
                item.addEventListener('click', () => {
                    const suggestionText = item.textContent.trim();
                    
                    // 发送建议内容作为用户消息
                    addMessage(suggestionText, 'user');
                    
                    // 模拟AI回复
                    setTimeout(() => {
                        addMessage('收到您的建议请求，我将根据"' + suggestionText + '"优化内容...', 'ai');
                    }, 1000);
                    
                    // 清空输入框
                    mainInput.value = '';
                    
                    // 隐藏建议面板
                    suggestionPanel.classList.remove('visible');
                });
                
                // 鼠标进入时设置为活动项
                item.addEventListener('mouseenter', () => {
                    // 移除之前的活动项
                    suggestionItems.forEach(i => i.classList.remove('active'));
                    // 设置当前项为活动项
                    item.classList.add('active');
                    activeIndex = index;
                });
            });
            
            // 当建议面板显示时，自动选中第一个选项
            function autoSelectFirstSuggestion() {
                // 监听建议面板的可见性变化
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.target === suggestionPanel && 
                            suggestionPanel.classList.contains('visible')) {
                            // 当面板变为可见时，选中第一个选项
                            activeIndex = 0;
                            updateActiveSuggestion(suggestionItems, activeIndex);
                        }
                    });
                });
                
                // 配置观察器
                observer.observe(suggestionPanel, { 
                    attributes: true, 
                    attributeFilter: ['class'] 
                });
            }
            
            // 初始化自动选中功能
            autoSelectFirstSuggestion();
        }
        
        // 更新活动建议项的函数（移到全局作用域）
        function updateActiveSuggestion(suggestionItems, activeIndex) {
            // 移除所有活动类
            suggestionItems.forEach(item => item.classList.remove('active'));
            
            // 如果有有效的活动索引，添加活动类
            if (activeIndex >= 0 && activeIndex < suggestionItems.length) {
                suggestionItems[activeIndex].classList.add('active');
                
                // 确保活动项在视图中 - 对于suggestion-option不需要滚动，因为已经全部显示
                if (!suggestionItems[activeIndex].classList.contains('suggestion-option')) {
                    suggestionItems[activeIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }
        }

        // 更新IP人物位置的函数
        function updateIpCharacterPosition() {
            const ipCharacterContainer = document.getElementById('ipCharacterContainer');
            if (!ipCharacterContainer || toolbar.style.display === 'none') return;
            
            const toolbarRect = toolbar.getBoundingClientRect();
            
            // 将IP人物定位到工具栏右侧
            ipCharacterContainer.style.top = (toolbarRect.top + toolbarRect.height / 2 - 30) + 'px';
            ipCharacterContainer.style.left = (toolbarRect.right + 5) + 'px';
        }

        // 监听左侧面板滚动事件，更新工具栏位置
        leftPanel.addEventListener('scroll', () => {
            // 如果工具栏可见且有选中元素，更新工具栏位置
            if (isToolbarVisible && selectedElement && !hasCustomPosition) {
                const rect = selectedElement.getBoundingClientRect();
                showToolbar(rect, isSecondAppearance);
            }
        });

        // 清空工具栏按钮
        function clearToolbarButtons() {
            // 保存标题和分隔线的引用
            const title = toolbar.querySelector('.toolbar-title');
            const divider = toolbar.querySelector('.toolbar-divider');
            
            // 移除所有按钮
            toolbar.querySelectorAll('button').forEach(btn => btn.remove());
            
            // 清空工具栏
            toolbar.innerHTML = '';
            
            // 重新添加标题和分隔线
            if (title) toolbar.appendChild(title);
            else {
                const newTitle = document.createElement('div');
                newTitle.className = 'toolbar-title';
                newTitle.id = 'toolbarDragHandle';
                newTitle.textContent = 'Kimmy 猜你想';
                toolbar.appendChild(newTitle);
            }
            
            if (divider) toolbar.appendChild(divider);
            else {
                const newDivider = document.createElement('div');
                newDivider.className = 'toolbar-divider';
                newDivider.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="148" height="2" viewBox="0 0 148 2" fill="none">
                  <path d="M0 1H148" stroke="black" stroke-opacity="0.3" stroke-linejoin="round" stroke-dasharray="1 3"/>
                </svg>`;
                toolbar.appendChild(newDivider);
            }
        }
        
        // 根据选中元素类型添加工具栏按钮
        function addToolbarButtonsByElementType() {
            if (!selectedElement) return;
            
            let buttons = [];
            
            // 根据元素类型添加不同的按钮
            if (selectedElement.tagName === 'IMG' || selectedElement.classList.contains('article-image')) {
                // 图片类型
                buttons = [
                    { icon: '🔄', text: '替换图片' },
                    { icon: '✨', text: '生成&优化' },
                    { icon: '✂️', text: '裁剪图片' },
                    { icon: '🔗', text: '添加链接' },
                    { icon: '🗑️', text: '删除', class: 'delete-button' }
                ];
            } else if (selectedElement.classList.contains('feature-icon')) {
                // 图标类型
                buttons = [
                    { icon: '🔄', text: '替换图标' },
                    { icon: '🔗', text: '添加链接' },
                    { icon: '🗑️', text: '删除', class: 'delete-button' }
                ];
            } else if (selectedElement.tagName === 'BUTTON' || 
                      selectedElement.classList.contains('cta-button') || 
                      selectedElement.tagName === 'A') {
                // 按钮类型
                buttons = [
                    { icon: '✍️', text: '修改文本' },
                    { icon: '🔗', text: '添加链接' },
                    { icon: '🗑️', text: '删除', class: 'delete-button' }
                ];
            } else {
                // 默认文本类型
                buttons = [
                    { icon: '✍️', text: '修改文本' },
                    { icon: '🔗', text: '添加链接' },
                    { icon: '🗑️', text: '删除', class: 'delete-button' }
                ];
            }
            
            // 添加按钮到工具栏
            const title = toolbar.querySelector('.toolbar-title');
            const divider = toolbar.querySelector('.toolbar-divider');
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                if (btn.class) button.className = btn.class;
                button.innerHTML = `<span class="icon">${btn.icon}</span> ${btn.text}`;
                
                // 添加点击事件，点击后隐藏工具栏
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 执行按钮对应的操作（这里可以添加具体功能）
                    console.log(`执行操作: ${btn.text}`);
                    
                    // 如果是修改文本按钮，进入文本编辑模式
                    if (btn.text === '修改文本' && selectedElement) {
                        // 进入文本编辑模式
                        isTextEditMode = true;
                        
                        // 将选中元素设为可编辑
                        selectedElement.contentEditable = true;
                        selectedElement.focus();
                        
                        // 选中全部文本并闪动光标
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(selectedElement);
                        selection.removeAllRanges();
                        selection.addRange(range);
                        
                        // 隐藏工具栏但不取消选中状态
                        hideToolbar();
                        return;
                    }
                    
                    // 隐藏工具栏
                    hideToolbar();
                    
                    // 如果是删除按钮，还需要取消选中元素
                    if (btn.class === 'delete-button') {
                        deselectElement(true, true);
                    }
                });
                
                // 在分隔线之前插入普通按钮，在分隔线之后插入删除按钮
                if (btn.class === 'delete-button') {
                    toolbar.appendChild(button);
                } else {
                    toolbar.insertBefore(button, divider);
                }
            });
            
            // 添加箭头
            const arrow = document.createElement('div');
            arrow.className = 'toolbar-arrow';
            arrow.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="13" height="32" viewBox="0 0 13 32" fill="none">
                <path d="M11.6226 13.7987C12.905 14.9861 12.905 17.0139 11.6226 18.2013L3.09424 26.0979C1.416 27.6518 0.323455 29.7358 1.46226e-06 32L2.86102e-06 -6.11959e-07C0.323455 2.26418 1.416 4.34815 3.09424 5.90207L11.6226 13.7987Z" fill="white"/>
            </svg>`;
            toolbar.appendChild(arrow);
        }

        // 在页面加载完成后初始化所有功能
        document.addEventListener('DOMContentLoaded', () => {
            initSelectableElements();
            initToolbarDrag();
            initInputFocus();
            initSuggestionItems();
            initGlobalKeyboardListener(); // 添加全局键盘监听初始化
            
            // 初始化工具栏标题和分隔线引用
            window.toolbarTitle = document.getElementById('toolbarDragHandle');
            window.toolbarDivider = toolbar.querySelector('.toolbar-divider');
            
            // 确保inputTagContainer完全隐藏且不占空间
            inputTagContainer.classList.remove('visible');
            inputTagContainer.classList.remove('hiding');
            inputTagContainer.innerHTML = '';
            inputTagContainer.style.height = '0';
            inputTagContainer.style.minHeight = '0';
            inputTagContainer.style.padding = '0';
            inputWrapper.classList.remove('with-tag');
        });

        // 添加键盘事件监听，处理Enter键退出编辑模式
        document.addEventListener('keydown', (e) => {
            // 如果当前处于文本编辑模式且按下了Enter键
            if (isTextEditMode && e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // 阻止默认行为（防止换行）
                
                // 退出编辑模式
                if (selectedElement) {
                    // 取消可编辑状态
                    selectedElement.contentEditable = false;
                    isTextEditMode = false;
                    
                    // 取消文本选择
                    window.getSelection().removeAllRanges();
                    
                    // 保持元素的选中状态，可以再次使用工具栏
                    selectedElement.classList.add('selected');
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            // 如果处于文本编辑模式，不触发输入框焦点
            if (isTextEditMode) {
                return;
            }
            
            // 只有在以下条件下才进行处理：
            // 1. 输入的是可打印字符或特殊按键如退格键
            // 2. 当前焦点不在输入框、文本区域或其他表单元素上
            // 3. 没有按下修饰键 (Alt, Ctrl, Meta)
            if (e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete') {
                if (!(document.activeElement === mainInput || 
                      document.activeElement.tagName === 'INPUT' || 
                      document.activeElement.tagName === 'TEXTAREA')) {
                    if (!e.altKey && !e.ctrlKey && !e.metaKey) {
                        // 聚焦到输入框
                        mainInput.focus();
                    }
                }
            }
        });
    </script>
</body>
</html> 